<!DOCTYPE html>
<html lang="vi" x-data="app()" xmlns="http://www.w3.org/1999/xhtml">

<head>
  <meta charset="UTF-8" />
  <title>Ứng dụng số hóa câu hỏi từ ảnh</title>
  <link rel="icon" type="image/x-icon"
    href="https://static-cloud.lotuslms.com/static/aeglobal/2025/04/16/42/6576b1b5d18d78fd5f032742/67ff0c984c83a5493c0fb176.png">
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    function app() {
      return {
        step: -1,
        username: '',
        password: '',
        uiid: '',
        token: '',
        uploadedFiles: '',
        imagePreviews: [], // Sẽ lưu trữ { url, name } để hiển thị
        ocrResults: [],
        editedQuestions: [],
        selectedQuestions: [],
        selectAll: false,
        selectedBank: '',      // Lưu iid của ngân hàng
        selectedBankLink: '',  // Dùng để nhập link ngân hàng
        bankName: '',          // Tên ngân hàng từ API
        bankError: '',         // Thông báo lỗi nếu có
        isLoading: false,
        inputType: 'image',
        inputText: '',

        async login() {
          if (!this.username || !this.password) {
            alert("Vui lòng nhập tên đăng nhập và mật khẩu");
            return;
          }

          try {
            const response = await fetch('https://n8n-vdi.nport.link/webhook/login-lms', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ u: this.username, p: this.password })
            });

            const result = await response.json();

            if (result.success && result.uiid && result.token) {
              localStorage.setItem('user', JSON.stringify({
                uiid: result.uiid,
                token: result.token,
                username: this.username
              }));
              this.uiid = result.uiid;
              this.token = result.token;
              this.step = 1;
            } else {
              alert(result.message || "Đăng nhập thất bại");
            }
          } catch (err) {
            console.error(err);
            alert("Lỗi kết nối đến máy chủ.");
          }
        },

        async checkAuth() {
          const userStr = localStorage.getItem('user');
          if (!userStr) {
            this.step = 0;
            return;
          }

          const { uiid, token } = JSON.parse(userStr);

          try {
            const res = await fetch('https://n8n-vdi.nport.link/webhook/check-user', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ uiid, token })
            });

            const data = await res.json();
            if (data.success) {
              const user = JSON.parse(userStr);
              this.username = user.username;
              this.uiid = user.uiid;
              this.token = user.token;
              this.step = 1;
            } else {
              localStorage.removeItem('user');
              alert("Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.");
              this.step = 0;
            }
          } catch (err) {
            console.error(err);
            alert("Không thể kiểm tra phiên đăng nhập.");
            this.step = 0;
          }
        },

        async confirmBank() {
          if (!this.selectedBankLink) {
            alert("Vui lòng nhập link ngân hàng");
            return;
          }

          this.isLoading = true;
          this.bankError = '';
          this.bankName = '';

          const formData = new FormData();
          formData.append('link', this.selectedBankLink);
          formData.append('token', this.token);
          formData.append('uiid', this.uiid);

          try {
            const response = await fetch('https://n8n-vdi.nport.link/webhook/find-bank ', {
              method: 'POST',
              body: formData
            });

            const result = await response.json();

            if (result.success) {
              this.selectedBank = result.iid; // Lưu iid
              this.bankName = result.name;
            } else {
              this.bankError = result.message || "Không thể truy cập ngân hàng này";
            }
          } catch (err) {
            console.error(err);
            this.bankError = "Lỗi kết nối đến máy chủ.";
          } finally {
            this.isLoading = false;
          }
        },

        async handleFileInput(event) {
          const files = event.target.files;
          const maxSizeInBytes = 1 * 1024 * 1024; // 1MB

          if (!files) return;

          this.uploadedFiles = [...this.uploadedFiles, ...Array.from(files)];

          for (let i = this.uploadedFiles.length - files.length; i < this.uploadedFiles.length; i++) {

            if (this.uploadedFiles[i].size > maxSizeInBytes) {
              // Alert the user
              alert(`File "${this.uploadedFiles[i].name}" quá lớn. Hãy chọn file dưới 1MB.`);
              // Xóa file khỏi mảng uploadedFiles
              this.uploadedFiles.splice(i, 1);
              continue;
            }

            this.imagePreviews.push({
              url: URL.createObjectURL(this.uploadedFiles[i]),
              name: this.uploadedFiles[i].name
            });
          }

        },

        removeImage(index) {
          // Xóa URL tạm thời để giải phóng bộ nhớ
          URL.revokeObjectURL(this.imagePreviews[index].url);
          // Xóa khỏi cả hai mảng
          this.imagePreviews.splice(index, 1);
          this.uploadedFiles.splice(index, 1);

          // Cập nhật lại input file để phản ánh sự thay đổi (cách này hơi phức tạp)
          // Cách đơn giản hơn là chỉ quản lý trong `filesToUpload` và sử dụng mảng này khi upload
          // Điều này đảm bảo dữ liệu gửi đi là chính xác.
        },

        async uploadImages(event) {
          this.isLoading = true;
          if (this.uploadedFiles.length && this.selectedBank || this.inputText && this.selectedBank) {
            // Giả lập OCR cho từng ảnh thành JSON
            this.ocrResults = [];
            this.editedQuestions = [];

            const API_URL = 'https://n8n-vdi.nport.link/webhook/upload-image';

            const formData = new FormData();
            if (this.inputType == "image") {
              Array.from(this.uploadedFiles).forEach((file, index) => {
                formData.append('data[]', file);
              });
            }

            if (this.inputType == "text") {
              formData.append('textContent', this.inputText);
            }

            formData.append('mode', this.inputType);
            formData.append('bank', this.selectedBank);
            formData.append('uiid', this.uiid);
            formData.append('token', this.token);

            // Gửi request lên API
            fetch(API_URL, {
              method: 'POST',
              body: formData
            })
              .then(response => {
                if (!response.ok) {
                  alert("Có thể đã xảy ra lỗi. Vui lòng thử lại")
                  this.isLoading = false;
                  return;
                }
                return response.json()
              })
              .then(data => {

                if (!data?.success) {
                  alert("Có thể đã xảy ra lỗi. Vui lòng thử lại")
                  this.isLoading = false;
                  return
                }

                if (!data?.data?.questions) {
                  alert("Có thể đã xảy ra lỗi. Vui lòng thử lại")
                  this.isLoading = false;
                  return
                }

                this.editedQuestions = data?.data?.questions.map((item) => {
                  if (item.type == "MC") {
                    return {
                      ...item,
                      answers: [0]
                    }
                  }

                  if (item.type == "MMC") {
                    return {
                      ...item,
                      answers: [0, 1]
                    }
                  }

                  if (item.type == "SA") {
                    const questionText = item.question;
                    const matches = [...questionText.matchAll(/__(.*?)__/g)];
                    const answers = matches.map(m => m[1]);
                    return {
                      ...item,
                      answers: answers
                    }
                  }

                  if (item.type == "TF") {
                    const statements = item.statements
                    return {
                      ...item,
                      statements: statements.map(item => ({ ...item, answer: 1 }))
                    }
                  }
                })
                this.step = 2;
                this.isLoading = false;

              })
              .catch(err => {
                console.error(err);
                alert(`Lỗi tải ảnh ${file.name} lên server`);
              });


          } else {
            if (!this.selectedBank) {
              alert("Vui lòng xác nhận chọn ngân hàng trước.");
            } else {
              alert("Vui lòng tải ít nhất một ảnh");
            }
            this.isLoading = false;
          }
        },

        confirmEdit() {
          this.step = 3;
        },

        toggleQuestion(index) {
          const i = this.selectedQuestions.indexOf(index);
          if (i === -1) {
            this.selectedQuestions.push(index);
          } else {
            this.selectedQuestions.splice(i, 1);
          }
          this.selectAll = this.selectedQuestions.length === this.editedQuestions.length;
        },

        selectAllQuestions(event) {
          this.selectAll = event.target.checked;
          if (this.selectAll) {
            this.selectedQuestions = [...Array(this.editedQuestions.length).keys()];
          } else {
            this.selectedQuestions = [];
          }
        },

        async digitize() {
          if (this.selectedQuestions.length === 0) {
            alert("Vui lòng chọn ít nhất một câu hỏi để số hóa.");
            return;
          }

          const selectedQuestionsData = this.selectedQuestions.map(i => this.editedQuestions[i]);
          this.isLoading = true;
          fetch('https://n8n-vdi.nport.link/webhook/sohoa', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              questions: selectedQuestionsData,
              bank: this.selectedBank,
              uiid: this.uiid,
              token: this.token
            })
          })
            .then(response => {
              if (!response.ok) throw new Error("Gửi dữ liệu thất bại");
              return response.json();
            })
            .then(result => {
              console.log("Số hóa thành công:", result);
              this.isLoading = false;
              this.step = 5;
            })
            .catch(error => {
              console.error("Lỗi:", error);
              this.isLoading = false;
              alert("Có lỗi xảy ra khi thực hiện số hóa.");
              this.step = 3;
            });
        },

        addQuestion(type) {
          if (type === 'MC') {
            this.editedQuestions.push({
              type: 'MC',
              question: 'Câu chọn đáp án đúng nhất',
              options: ['Lựa chọn 1', 'Lựa chọn 2', 'Lựa chọn 3', 'Lựa chọn 4'],
              answers: [0]
            });
          } else if (type === 'MMC') {
            this.editedQuestions.push({
              type: 'MMC',
              question: 'Câu chọn nhiều đáp án đúng',
              options: ['Lựa chọn 1', 'Lựa chọn 2', 'Lựa chọn 3', 'Lựa chọn 4'],
              answers: [0, 1]
            });
          } else if (type === 'SA') {
            this.editedQuestions.push({
              type: 'SA',
              question: 'Câu hỏi điền vào chỗ trống: __đáp án__.',
              answers: []
            });
          } else if (type === 'TF') {
            this.editedQuestions.push({
              type: 'TF',
              question: 'Xác định tính đúng/sai:',
              statements: [
                { content: '', answer: 'true' },
                { content: '', answer: 'true' },
                { content: '', answer: 'true' }
              ]
            });
          }
        },

        removeQuestion(index) {
          this.editedQuestions.splice(index, 1);
        },

        extractAnswersFromFill(qIndex) {
          const questionText = this.editedQuestions[qIndex].question;
          const matches = [...questionText.matchAll(/__(.*?)__/g)];
          const answers = matches.map(m => m[1]);
          this.editedQuestions[qIndex].answers = answers;
        },

        toggleAnswer(qIndex, optionIndex) {
          const index = this.editedQuestions[qIndex].answers.indexOf(optionIndex);
          if (index === -1) {
            this.editedQuestions[qIndex].answers.push(optionIndex);
          } else {
            this.editedQuestions[qIndex].answers.splice(index, 1);
          }
        },

        addOption(qIndex) {
          this.editedQuestions[qIndex].options.push('');
        },

        removeOption(qIndex, oIndex) {
          const q = this.editedQuestions[qIndex];
          q.options.splice(oIndex, 1);
          const ansIndex = q.answers.indexOf(oIndex);
          if (ansIndex !== -1) q.answers.splice(ansIndex, 1);
          q.answers = q.answers.map(a => a > oIndex ? a - 1 : a);
        },

        addStatement(qIndex) {
          this.editedQuestions[qIndex].statements.push({ content: '', answer: 'true' });
        },

        removeStatement(qIndex, sIndex) {
          this.editedQuestions[qIndex].statements.splice(sIndex, 1);
        },
        logout() {
          if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
            // Xóa thông tin người dùng khỏi localStorage
            localStorage.removeItem('user');

            // Reset toàn bộ trạng thái
            this.username = '';
            this.password = '';
            this.selectedBank = '';
            this.uploadedFiles = [];
            this.ocrResults = [];
            this.editedQuestions = [];
            this.selectedQuestions = [];
            this.selectAll = false;

            // Quay về bước đăng nhập
            this.step = 0;
          }
        },

        goBack() {
          if (this.step === 5 || this.step === 4) {
            this.step = 3;
          } else {
            this.step--
          }
        },

        newSession() {
          this.step = 1;
        },

        setAnswer(qIndex, oIndex) {
          this.editedQuestions[qIndex].answers = [oIndex];
        },

        setMMCAnswer(qIndex, oIndex) {
          const index = this.editedQuestions[qIndex].answers.indexOf(oIndex);
          if (index === -1) {
            this.editedQuestions[qIndex].answers.push(oIndex);
          } else {
            this.editedQuestions[qIndex].answers.splice(index, 1);
          }
        },

        init() {
          this.checkAuth();
        }
      };
    }
  </script>
</head>

<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4 font-sans antialiased" x-data="appData()">

  <!-- Overlay Loading Toàn màn hình -->
  <template x-if="isLoading">
    <div class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
      <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center space-x-4">
        <svg class="animate-spin h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none"
          viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V4a10 10 0 1010 10h-2a8 8 0 01-8-8z"></path>
        </svg>
        <span class="text-lg font-semibold text-slate-700">Đang xử lý, vui lòng chờ...</span>
      </div>
    </div>
  </template>

  <!-- Container chính -->
  <div class="w-full max-w-4xl bg-white shadow-xl rounded-xl p-8 space-y-8">

    <!-- Header -->
    <header class="flex justify-between items-center pb-4 border-b border-slate-200">
      <div class="flex items-center">
        <img src="https://static-cloud.lotuslms.com/2023/12/11/42/6576b1b5d18d78fd5f032742/6576b668c45cb914b9036ab0.png"
          alt="Logo" class="h-8 w-auto mr-3">
        <h1 class="text-2xl font-bold text-slate-800">Số Hóa Câu Hỏi Từ Ảnh</h1>
      </div>
      <div x-show="step > 0" class="bg-slate-100 rounded-full p-2 px-4 text-sm flex items-center space-x-3">
        <span class="text-slate-600">Tài khoản: <strong class="font-semibold text-slate-800"
            x-text="username"></strong></span>
        <button @click="logout()" class="font-semibold text-red-600 hover:text-red-800 transition-colors">
          Đăng xuất
        </button>
      </div>
    </header>

    <!-- Breadcrumb được thiết kế lại -->
    <div class="flex items-center space-x-2 text-xs md:text-sm">
      <div class="flex items-center">
        <span :class="step >= 0 ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'"
          class="w-6 h-6 rounded-full flex items-center justify-center font-bold">1</span>
        <span :class="step >= 0 ? 'text-indigo-600' : 'text-slate-500'" class="ml-2 font-semibold">Đăng nhập</span>
      </div>
      <div :class="step >= 1 ? 'border-indigo-600' : 'border-slate-200'" class="flex-1 border-t-2"></div>
      <div class="flex items-center">
        <span :class="step >= 1 ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'"
          class="w-6 h-6 rounded-full flex items-center justify-center font-bold">2</span>
        <span :class="step >= 1 ? 'text-indigo-600' : 'text-slate-500'" class="ml-2 font-semibold">Tải lên</span>
      </div>
      <div :class="step >= 2 ? 'border-indigo-600' : 'border-slate-200'" class="flex-1 border-t-2"></div>
      <div class="flex items-center">
        <span :class="step >= 2 ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'"
          class="w-6 h-6 rounded-full flex items-center justify-center font-bold">3</span>
        <span :class="step >= 2 ? 'text-indigo-600' : 'text-slate-500'" class="ml-2 font-semibold">Chỉnh sửa</span>
      </div>
      <div :class="step >= 3 ? 'border-indigo-600' : 'border-slate-200'" class="flex-1 border-t-2"></div>
      <div class="flex items-center">
        <span :class="step >= 3 ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'"
          class="w-6 h-6 rounded-full flex items-center justify-center font-bold">4</span>
        <span :class="step >= 3 ? 'text-indigo-600' : 'text-slate-500'" class="ml-2 font-semibold">Xác nhận</span>
      </div>
      <div :class="step >= 5 ? 'border-indigo-600' : 'border-slate-200'" class="flex-1 border-t-2"></div>
      <div class="flex items-center">
        <span :class="step >= 5 ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'"
          class="w-6 h-6 rounded-full flex items-center justify-center font-bold">5</span>
        <span :class="step >= 5 ? 'text-indigo-600' : 'text-slate-500'" class="ml-2 font-semibold">Hoàn tất</span>
      </div>
    </div>

    <!-- Các bước của quy trình -->
    <main>
      <!-- B0: Đăng nhập -->
      <template x-if="step === 0">
        <div class="max-w-md mx-auto">
          <h2 class="text-xl font-semibold mb-6 text-slate-700 text-center">Đăng nhập tài khoản</h2>
          <div class="space-y-4">
            <div>
              <label for="username" class="block text-sm font-medium text-slate-700 mb-1">Tên đăng nhập:</label>
              <input id="username" type="text" x-model="username"
                class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"
                placeholder="Nhập tên đăng nhập" />
            </div>
            <div>
              <label for="password" class="block text-sm font-medium text-slate-700 mb-1">Mật khẩu:</label>
              <input id="password" type="password" x-model="password"
                class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"
                placeholder="Nhập mật khẩu" />
            </div>
            <button @click="login()"
              class="mt-4 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">Đăng
              nhập</button>
          </div>
        </div>
      </template>

      <!-- B1: Tải ảnh & Chọn ngân hàng -->
      <template x-if="step === 1">
        <div>
          <h2 class="text-xl font-semibold mb-6 text-slate-700">Tải lên & Chọn ngân hàng câu hỏi</h2>
          <div class="space-y-6">
            <div>
              <label for="bankLink" class="block text-sm font-medium text-slate-700 mb-2">Nhập link ngân hàng:</label>
              <div class="flex items-center space-x-3">
                <input id="bankLink" type="text" x-model="selectedBankLink"
                  placeholder="Ví dụ: https://aeglobal.lotuslms.com/admin/content-manager/folder/68aec351a6652b2ccd024421"
                  class="flex-grow block rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"
                  autocomplete="off" />
                <button @click="confirmBank"
                  class="inline-flex items-center px-5 py-2.5 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all">Xác
                  nhận</button>
              </div>
              <p x-show="bankName" class="mt-2 text-sm text-green-600 font-medium"
                x-text="`✓ Tên ngân hàng: ${bankName}`"></p>
              <p x-show="bankError" class="mt-2 text-sm text-red-600 font-medium" x-text="`✗ ${bankError}`"></p>
            </div>

            <div class="border-t border-slate-200 pt-6">
              <div class="flex items-center space-x-6 mb-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" name="inputType" value="image" checked x-model="inputType"
                    class="form-radio h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500">
                  <span class="font-medium text-slate-700">Tải ảnh lên</span>
                </label>
                <label class="flex items-center space-x-2 cursor-pointer">
                  <input type="radio" name="inputType" value="text" x-model="inputType"
                    class="form-radio h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500">
                  <span class="font-medium text-slate-700">Nhập văn bản</span>
                </label>
              </div>

              <div x-show="inputType === 'image'">
                <label for="file-upload"
                  class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                  <div class="flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                    <div class="space-y-1 text-center">
                      <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none"
                        viewBox="0 0 48 48" aria-hidden="true">
                        <path
                          d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                      <div class="flex text-sm text-slate-600">
                        <p class="pl-1">Kéo thả hoặc <span class="text-indigo-600 font-semibold">chọn nhiều file</span>
                          để tải lên</p>
                        <!-- Thêm id 'file-upload' vào input -->
                        <input id="file-upload" type="file" multiple accept="image/*" @change="handleFileInput"
                          class="sr-only">
                      </div>
                      <p class="text-xs text-slate-500">PNG, JPG, GIF up to 1MB</p>
                    </div>
                  </div>
                </label>

                <!-- NEW: Vùng hiển thị ảnh đã chọn -->
                <div x-show="imagePreviews.length > 0" class="mt-6">
                  <h3 class="text-sm font-medium text-slate-700 mb-2" x-text="`Đã chọn ${imagePreviews.length} ảnh:`">
                  </h3>
                  <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                    <template x-for="(image, index) in imagePreviews" :key="index">
                      <div class="relative group aspect-square">
                        <img :src="image.url" alt="Image preview"
                          class="w-full h-full object-cover rounded-lg shadow-sm">
                        <div
                          class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-center justify-center rounded-lg">
                          <button @click="removeImage(index)"
                            class="absolute top-1 right-1 h-6 w-6 bg-red-600 text-white rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity focus:outline-none focus:ring-2 focus:ring-red-500">
                            &times;
                          </button>
                        </div>
                        <p class="text-xs text-slate-600 truncate mt-1" x-text="image.name"></p>
                      </div>
                    </template>
                  </div>
                </div>
                <!-- END NEW -->
              </div>

              <div x-show="inputType === 'text'">
                <label for="text-input" class="block text-sm font-medium text-slate-700 mb-1">Nhập nội dung:</label>
                <textarea id="text-input" x-model="inputText" rows="8"
                  class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-500 focus:ring-opacity-50"
                  placeholder="Nhập hoặc dán nội dung câu hỏi vào đây..."></textarea>
              </div>
            </div>
          </div>
          <div class="flex justify-end items-center mt-8">
            <button @click="uploadImages"
              class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
              Tiếp tục
              <svg xmlns="http://www.w3.org/2000/svg" class="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </template>

      <!-- ... (Các bước còn lại không thay đổi) ... -->
      <template x-if="step === 2">
        <div>
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold text-slate-700">Chỉnh sửa nội dung câu hỏi</h2>
            <div class="flex items-center space-x-2">
              <span class="text-sm font-medium text-slate-600">Thêm mới:</span>
              <button @click="addQuestion('MC')"
                class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600 transition">MC</button>
              <button @click="addQuestion('MMC')"
                class="px-3 py-1.5 text-xs font-semibold text-white bg-yellow-500 rounded-md hover:bg-yellow-600 transition">MMC</button>
              <button @click="addQuestion('SA')"
                class="px-3 py-1.5 text-xs font-semibold text-white bg-green-500 rounded-md hover:bg-green-600 transition">SA</button>
              <button @click="addQuestion('TF')"
                class="px-3 py-1.5 text-xs font-semibold text-white bg-purple-500 rounded-md hover:bg-purple-600 transition">TF</button>
            </div>
          </div>

          <div class="space-y-6">
            <template x-for="(q, qIndex) in editedQuestions" :key="qIndex">
              <div class="border border-slate-200 rounded-lg p-4 bg-slate-50 shadow-sm space-y-4">
                <div class="flex justify-between items-center pb-3 border-b border-slate-200">
                  <strong class="font-semibold text-indigo-700" x-text="`Câu hỏi ${qIndex + 1}: [${q.type}]`"></strong>
                  <button @click="removeQuestion(qIndex)"
                    class="text-red-500 hover:text-red-700 text-sm font-medium">Xóa câu hỏi</button>
                </div>

                <!-- MC & MMC -->
                <div x-show="q.type === 'MC' || q.type === 'MMC'">
                  <div class="flex justify-between items-start mb-2">
                    <label class="font-medium text-slate-800">Nội dung câu hỏi:</label>
                    <button
                      @click="q.type === 'MC' ? (q.type = 'MMC') : (q.type = 'MC', q.answers = [q.answers[0] || 0])"
                      class="px-2 py-1 text-xs font-semibold bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                      <span x-text="q.type === 'MC' ? 'Chuyển sang MMC' : 'Chuyển sang MC'"></span>
                    </button>
                  </div>
                  <input type="text" x-model="q.question"
                    class="w-full border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                  <div class="mt-3">
                    <label class="font-medium text-slate-800 block mb-2">Các tùy chọn:</label>
                    <div class="space-y-2">
                      <template x-for="(option, oIndex) in q.options" :key="oIndex">
                        <div class="flex items-center space-x-2">
                          <input type="text" x-model="q.options[oIndex]"
                            class="flex-1 border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                          <label class="flex items-center space-x-1.5">
                            <input x-show="q.type === 'MC'" type="radio" :name="`q-${qIndex}`"
                              :checked="q.answers[0] == oIndex" @click="setAnswer(qIndex, +oIndex)"
                              class="form-radio h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                            <input x-show="q.type === 'MMC'" type="checkbox" :checked="q.answers.includes(oIndex)"
                              @click="setMMCAnswer(qIndex, oIndex)"
                              class="form-checkbox h-4 w-4 text-indigo-600 rounded focus:ring-indigo-500">
                            <span class="text-sm text-slate-600">Đáp án</span>
                          </label>
                          <button @click="removeOption(qIndex, oIndex)"
                            class="p-1 text-slate-400 hover:text-red-600 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                              stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      </template>
                    </div>
                  </div>
                  <button @click="addOption(qIndex)"
                    class="mt-3 text-indigo-600 hover:text-indigo-800 font-semibold text-sm">+ Thêm tùy chọn</button>
                </div>

                <!-- SA (Short Answer / Fill) -->
                <div x-show="q.type === 'SA'">
                  <label class="block mb-2 font-medium text-slate-800">Nội dung câu hỏi (dùng `__` để đánh dấu vị trí
                    đáp án):</label>
                  <textarea x-model="q.question" @input="extractAnswersFromFill(qIndex)" rows="4"
                    class="w-full border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                  <div class="mt-2 p-3 bg-indigo-50 rounded-md">
                    <label class="font-medium text-sm text-indigo-800 block">Đáp án được trích xuất:</label>
                    <div class="text-sm text-slate-600 font-mono"
                      x-text="q.answers && q.answers.length > 0 ? q.answers.join(', ') : 'Chưa có đáp án nào.'"></div>
                  </div>
                </div>

                <!-- TF (True/False) -->
                <div x-show="q.type === 'TF'">
                  <label class="block mb-2 font-medium text-slate-800">Tiêu đề chung:</label>
                  <input type="text" x-model="q.title"
                    class="w-full border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                  <div class="mt-3">
                    <label class="font-medium text-slate-800 block mb-2">Các phát biểu:</label>
                    <div class="space-y-2">
                      <template x-for="(stmt, sIndex) in q.statements" :key="sIndex">
                        <div class="flex items-center space-x-2">
                          <input type="text" x-model="stmt.content"
                            class="flex-1 border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                          <select x-model="stmt.answer"
                            class="border-slate-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option value=1>Đúng</option>
                            <option value=0>Sai</option>
                          </select>
                          <button @click="removeStatement(qIndex, sIndex)"
                            class="p-1 text-slate-400 hover:text-red-600 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                              stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      </template>
                    </div>
                  </div>
                  <button @click="addStatement(qIndex)"
                    class="mt-3 text-indigo-600 hover:text-indigo-800 font-semibold text-sm">+ Thêm phát biểu</button>
                </div>
              </div>
            </template>
          </div>

          <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-200">
            <button @click="goBack()" type="button"
              class="inline-flex items-center px-5 py-2.5 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clip-rule="evenodd" />
              </svg>
              Quay lại
            </button>
            <button @click="confirmEdit"
              class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
              Xác nhận & Tiếp tục
              <svg xmlns="http://www.w3.org/2000/svg" class="ml-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                  clip-rule="evenodd" />
              </svg>
            </button>
          </div>
        </div>
      </template>

      <template x-if="step === 3">
        <div>
          <h2 class="text-xl font-semibold mb-2 text-slate-700">Chọn câu hỏi để số hóa</h2>
          <p class="text-sm text-slate-500 mb-6">Chỉ những câu hỏi được chọn mới được thêm vào ngân hàng.</p>
          <div class="mb-4 p-3 bg-slate-100 rounded-md">
            <label class="flex items-center space-x-3 cursor-pointer">
              <input type="checkbox" x-model="selectAll" @click="selectAllQuestions" id="selectAll"
                class="h-5 w-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500">
              <span for="selectAll" class="font-semibold text-slate-800">Chọn tất cả</span>
            </label>
          </div>

          <div class="space-y-3">
            <template x-for="(question, index) in editedQuestions" :key="index">
              <label class="flex items-start space-x-4 p-4 border rounded-lg cursor-pointer transition-colors"
                :class="selectedQuestions.includes(index) ? 'bg-indigo-50 border-indigo-300' : 'bg-white border-slate-200 hover:bg-slate-50'">
                <input type="checkbox" :checked="selectedQuestions.includes(index)" @click="toggleQuestion(index)"
                  class="mt-1 h-5 w-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 shrink-0">
                <span class="text-sm text-slate-700 whitespace-pre-wrap"
                  x-text="`${index + 1}. ${question.type == 'TF' ? question.title : question.question}`"></span>
              </label>
            </template>
          </div>

          <div class="flex justify-between items-center mt-8 pt-6 border-t border-slate-200">
            <button @click="goBack()" type="button"
              class="inline-flex items-center px-5 py-2.5 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                  clip-rule="evenodd" />
              </svg>
              Quay lại
            </button>
            <button @click="digitize"
              class="inline-flex items-center px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
              Số hóa các câu đã chọn
            </button>
          </div>
        </div>
      </template>

      <template x-if="step === 5">
        <div class="flex flex-col items-center justify-center text-center py-12">
          <div class="p-4 bg-green-100 rounded-full mb-4">
            <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
              </path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-slate-800">Số hóa thành công!</h2>
          <p class="text-slate-600 text-lg mt-2 mb-8">
            Các câu hỏi đã được lưu vào ngân hàng <strong class="text-indigo-600" x-text="bankName"></strong>.
          </p>
          <button @click="newSession" type="button"
            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="mr-2 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                clip-rule="evenodd" />
            </svg>
            Tạo phiên làm việc mới
          </button>
        </div>
      </template>
    </main>

    <!-- Footer -->
    <footer class="mt-8 border-t border-slate-200 pt-6 text-center text-sm text-slate-500">
      <p>
        Cần trợ giúp?
        <a href="https://docs.google.com/document/d/13nGqkB_lTaCx5ruf2Im0xQ3ICyPKVMbc3kZgybehCWA/edit?tab=t.0"
          target="_blank" class="font-medium text-indigo-600 hover:underline">
          Xem tài liệu hướng dẫn
        </a>
      </p>
      <p class="mt-2 text-xs">© 2025 - Nền tảng số hóa câu hỏi</p>
    </footer>
  </div>
</body>

</html>